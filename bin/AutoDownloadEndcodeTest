#!/usr/bin/env ruby

# HandBrakeCLI -Z "iPhone \& iPod Touch" -2 -T -b 768 -B 48 -6 stereo -5 default -i Batman:\ The\ Brave\ and\ the\ Bold-The\ Golden\ Age\ of\ Justice-31.mpg -o Batman:\ The\ Brave\ and\ the\ Bold-The\ Golden\ Age\ of\ Justice-31.m4v

# This has -Z "iPhone" expanded so I could tweak a few things
# HandBrakeCLI -v 0 -e x264 -b 768 -2 -T -5 default --crop 5:0:0:0 -a 1 -E faac -B 48 -6 stereo -R 48 -D 0.0 -f mp4 -X 480 -m -x cabac=0:ref=2:me=umh:bframes=0:subme=6:8x8dct=0:trellis=0 -i Batman:\ The\ Brave\ and\ the\ Bold-The\ Golden\ Age\ of\ Justice-31.mpg -o Batman:\ The\ Brave\ and\ the\ Bold-The\ Golden\ Age\ of\ Justice-31-2.m4v

# You must have tivodecode for this to work.
# Your tivo mak will be read out of ~/.tivodecode_mak if it is available

# Adds the lib path next to the path the script is in to the head of
# the search patch
$:.unshift File.expand_path(File.join(File.dirname(__FILE__), '..', 'lib',
                                      'httpclient-2.1.2', 'lib'))
$:.unshift File.expand_path(File.join(File.dirname(__FILE__), '..', 'lib'))

require 'optparse'
require 'TiVo.rb'
require 'facets/progressbar.rb'
require 'pp'

# Load the mak if we have a mak file
mak_file = ENV['HOME'] + '/.tivodecode_mak'
mak = nil
mak = File.read(mak_file).strip if File.exist?(mak_file)

tivo_addr = '192.168.69.179'

tivo = TiVo::TiVo.new(tivo_addr, mak)

shows = tivo.get_listings.videos.select { |p| p.title =~ /Batman/ }

shows.each do |show|
  tivo = TiVo::TiVo.new(tivo_addr, mak)

  basename = show.title + '-' + show.time_captured.strftime("%Y%m%d")
  basename.sub!(/:/, '_')

  download = basename + ".mpg"

  # downlaod the file
  IO.popen("tivodecode -o \"#{dl_name}\" -", 'wb') do |td|
    pbar = Console::ProgressBar.new(download, show.size)
    tivo.download_show(show) do |tc|
      td << tc
      pbar.inc(tc.length)
    end
    pbar.finish
    puts
  end

  transcode = basename + ".m4v"

  command = %w/-v 0 -e x264 -b 768 -2 -T -5 default --crop 5:0:0:0 -a 1 -E faac -B 48 -6 stereo -R 48 -D 0.0 -f mp4 -X 480 -m -x cabac=0:ref=2:me=umh:bframes=0:subme=6:8x8dct=0:trellis=0 -i/ << download << '-o' << transcode

  system("HandBrakeCLI", *command)
end

# Local Variables:
# mode: ruby
# End:
